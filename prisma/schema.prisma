generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Sex {
  M
  F
}

enum AnimalStatus {
  UNHOSTED
  FOSTERED
  ADOPTED
}

model Animal {
  id                Int          @id @default(autoincrement())
  name              String
  species           String
  sex               Sex
  color             String?
  findLocation      String?
  status            AnimalStatus @default(UNHOSTED)
  birthDate         DateTime     @map("birth_date") @db.Date
  isNeutered        Boolean      @map("is_neutered")
  lastVax           DateTime?    @map("last_vax") @db.Date
  vaxHistory        DateTime[]   @default([])
  isPrimoVax        Boolean      @default(false) @map("is_primo_vax")
  lastDeworm        DateTime?    @map("last_deworm") @db.Date
  dewormHistory     DateTime[]   @default([])
  isFirstDeworm     Boolean      @default(false) @map("is_first_deworm")
  information       String?
  healthInformation String?
  familyId          Int?         @map("family_id")
  orgId             Int          @map("organization_id")
  createdAt         DateTime     @default(now()) @map("created_at")
  createdByMemberId Int
  updatedAt         DateTime     @updatedAt
  updatedByMemberId Int?

  family       Family?           @relation(fields: [familyId], references: [id], onUpdate: NoAction)
  organization Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  healthActs   AnimalHealthAct[]
  adoption     AnimalAdoption?

  @@map("animals")
}

enum AnimalHealthActType {
  VACCINATION
  DEWORM
  ANTIFLEA
}

model AnimalHealthAct {
  id        Int                 @id @default(autoincrement())
  animalId  Int
  type      AnimalHealthActType
  date      DateTime            @db.Date
  isFirst   Boolean             @default(false)
  createdAt DateTime            @default(now())

  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@index([animalId, type, date])
}

model AnimalAdoption {
  id                       Int       @id @default(autoincrement())
  animalId                 Int       @unique
  adopterFullName          String?
  adopterEmail             String?
  adopterPhoneNumber       String?
  adopterAddress           String?
  adopterZip               String?
  adopterCity              String?
  homeVisitDone            Boolean   @default(false)
  neuteringPlannedAt       DateTime? @db.Date
  adoptionContractSignedAt DateTime? @db.Date
  adoptionFeePaid          Boolean   @default(false)
  legalTransferAt          DateTime? @db.Date
  information              String?
  createdAt                DateTime  @default(now())

  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)
}

model Family {
  id              Int      @id @default(autoincrement())
  contactFullName String   @map("contact_name")
  email           String?
  phoneNumber     String?  @map("phone_number")
  address         String
  zip             String
  city            String
  hasChildren     Boolean  @default(false)
  otherAnimals    String?
  orgId           Int      @map("organization_id")
  memberId        Int?
  createdAt       DateTime @default(now()) @map("created_at")

  animals      Animal[]
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  member       Member?      @relation(fields: [memberId], references: [id])

  @@unique([orgId, memberId])
  @@map("families")
}

enum MemberRole {
  MEMBER
  FOSTER_FAMILY
  ADMIN
  SUPERADMIN
}

enum MemberStatus {
  BANNED
  PENDING
  VALIDATED
}

model MemberOrganization {
  memberId Int          @map("member_id")
  orgId    Int          @map("organization_id")
  role     MemberRole
  status   MemberStatus
  joinedAt DateTime     @default(now()) @map("joined_at")

  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([memberId, orgId])
  @@map("member_organization")
}

model Member {
  id            Int      @id @default(autoincrement())
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  email         String   @unique
  phoneNumber   String   @unique @map("phone_number")
  passwordHash  String   @map("password_hash")
  selectedOrgId Int?
  createdAt     DateTime @default(now()) @map("created_at")

  memberOrganizations MemberOrganization[]
  resetPasswordTokens AuthToken[]
  families            Family[]

  @@map("members")
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  animals             Animal[]
  families            Family[]
  memberOrganizations MemberOrganization[]

  @@map("organizations")
}

enum TokenType {
  RESET_PASSWORD
}

model AuthToken {
  id        Int       @id @default(autoincrement())
  memberId  Int
  tokenHash String
  type      TokenType
  createdAt DateTime  @default(now())
  expiresAt DateTime

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tokenHash])
}
