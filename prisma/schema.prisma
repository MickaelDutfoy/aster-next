generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Sex {
  M
  F
}

enum AnimalStatus {
  UNHOSTED
  FOSTERED
  ADOPTED
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Animal {
  id            Int          @id @default(autoincrement())
  name          String
  species       String
  sex           Sex
  color         String?
  findLocation  String?
  birthDate     DateTime     @map("birth_date") @db.Date
  isNeutered    Boolean      @map("is_neutered")
  status        AnimalStatus @default(UNHOSTED)
  lastVax       DateTime?    @map("last_vax") @db.Date
  vaxHistory    DateTime[]   @default([])
  isPrimoVax    Boolean      @default(false) @map("is_primo_vax")
  lastDeworm    DateTime?    @map("last_deworm") @db.Date
  dewormHistory DateTime[]   @default([])
  isFirstDeworm Boolean      @default(false) @map("is_first_deworm")
  information   String?
  familyId      Int?         @map("family_id")
  orgId         Int          @map("organization_id")
  createdAt     DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  family       Family?         @relation(fields: [familyId], references: [id], onUpdate: NoAction)
  organization Organization    @relation(fields: [orgId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  adoption     AnimalAdoption?

  @@map("animals")
}

model AnimalAdoption {
  id                       Int       @id @default(autoincrement())
  animalId                 Int       @unique // <- 0-1 par animal (MVP)
  adopterFullName          String
  adopterEmail             String?
  adopterPhoneNumber       String?
  adopterAddress           String?
  adopterZip               String?
  adopterCity              String?
  homeVisitDone            Boolean   @default(false)
  knowledgeCertSignedAt    DateTime? @db.Date
  neuteringPlannedAt       DateTime? @db.Date
  adoptionContractSignedAt DateTime? @db.Date
  adoptionFeePaid          Boolean   @default(false)
  legalTransferAt          DateTime? @db.Date
  notes                    String?
  createdAt                DateTime? @default(now()) @db.Timestamptz(6)

  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)
}

model Family {
  id              Int       @id @default(autoincrement())
  contactFullName String    @map("contact_name")
  email           String?
  phoneNumber     String?   @map("phone_number")
  address         String
  zip             String
  city            String
  hasChildren     Boolean   @default(false)
  otherAnimals    String?
  orgId           Int       @map("organization_id")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  animals      Animal[]
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("families")
}

enum MemberRole {
  MEMBER
  SUPERADMIN
}

enum MemberStatus {
  PENDING
  VALIDATED
}

model MemberOrganization {
  memberId Int          @map("member_id")
  orgId    Int          @map("organization_id")
  role     MemberRole
  status   MemberStatus
  joinedAt DateTime?    @default(now()) @map("joined_at") @db.Timestamptz(6)

  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([memberId, orgId])
  @@map("member_organization")
}

model Member {
  id           Int       @id @default(autoincrement())
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  email        String    @unique
  phoneNumber  String    @unique @map("phone_number")
  passwordHash String    @map("password_hash")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  memberOrganizations MemberOrganization[]

  @@map("members")
}

model Organization {
  id        Int       @id @default(autoincrement())
  name      String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  animals             Animal[]
  families            Family[]
  memberOrganizations MemberOrganization[]

  @@map("organizations")
}
